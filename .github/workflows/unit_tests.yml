# This workflow will install Python dependencies and run tests with a single version of Python
name: Unit Tests on version 3.9.6

on:
  push:
    branches: [ "dev", "main" ]
  pull_request:
    branches: [ "dev", "main" ]

permissions:
  contents: read

jobs:
  build:

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        pip install pytest
        sudo apt update
        sudo apt install -y make build-essential libssl-dev zlib1g-dev libbz2-dev \
        libreadline-dev libsqlite3-dev wget curl llvm \
        libncurses5-dev libncursesw5-dev xz-utils tk-dev libffi-dev liblzma-dev python3-openssl git
    - name: Install pyenv
      run: |
        curl -L https://github.com/pyenv/pyenv-installer/raw/master/bin/pyenv-installer | bash
    - name: Setup pyenv and poetry
      run: |
        echo '#Adding Pyenv to path' >> ~/.bashrc
        echo 'export PYENV_ROOT="$HOME/.pyenv"' >> ~/.bashrc
        echo 'export PATH="$PYENV_ROOT/bin:$PATH"' >> ~/.bashrc
        echo -e 'if command -v pyenv 1>/dev/null 2>&1; then\n eval "$(pyenv init -)"\nfi' >> ~/.bashrc
        source ~/.bashrc
        pyenv install 3.9.6
        pyenv local 3.9.6
        curl -sSL https://install.python-poetry.org | python3 -
        echo '#Adding Poetry to path' >> ~/.bashrc
        echo 'export PATH="~/.local/bin:$PATH"' >> ~/.bashrc
        source ~/.bashrc
        poetry config virtualenvs.prefer-active-python true
        poetry config virtualenvs.in-project true
        poetry env use 3.9.6
    - name: Setup virtual environment with poetry
      run: |
        poetry install
        source ./.venv/bin/activate
    - name: Test with pytest
      run: |
        pytest